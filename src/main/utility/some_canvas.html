<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Коммуникации /HTML5 Camp. Демонстрации/</title>
    <link type="text/css" rel="stylesheet" href="styles/main.css" />
    <link type="text/css" rel="stylesheet" href="styles/connect.css" />
    <style>

    </style>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.min.js"></script>
    <script src="scripts/modernizr-latest.js"></script>
    <script>
        var log, state, entities, conn = {}, c1 = {}, c2 = {}, sender = "s" + Math.random().toString().slice(2);



        $(document).ready(function () {
            log = $("#log");
            state = $('#status'),
                entities = {
                    '<': '<',
                    '>': '>',
                    '&': '&'
                };

            initPainting();

            $(".view").each(function(e){
                $(this).bind("click", function(e) {
                    $(this).parent().toggleClass("hidden");

                    $(this).text(($(this).text() == "show")?"hide":"show");
                });
            });


        });

        function initPainting() {
            c1.source = $("#mycanvas");
            c1.part = 1;
            c1.context = c1.source[0].getContext("2d");

            c2.source = $("#othercanvas");
            c2.part = 2;
            c2.context = c2.source[0].getContext("2d");

            initCanvas(c1);
            initCanvas(c2);
        }

        function initCanvas(canvas) {
            var ctx = canvas.context;
            var c = canvas;
            canvas.isPainting = false;
            canvas.lastPoint = {};

            ctx.shadowColor =  "rgba(0, 0, 0, 0.75)";
            ctx.shadowBlur = 5;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;

            canvas.source.bind("mousedown", function(e) {
                canvas.isPainting = true;
                canvas.lastPoint = {x: e.offsetX, y: e.offsetY};
            });

            canvas.source.bind("mousemove", function(e) {
                if (canvas.isPainting) {
                    var line = {x1:canvas.lastPoint.x, y1:canvas.lastPoint.y, x2: e.offsetX, y2: e.offsetY};
                    drawLine(canvas.part, line);

                    if (conn.readyState === 1) {
                        conn.send(JSON.stringify({
                            sender:sender,
                            type:"canvas",
                            part:canvas.part,
                            line:line
                        }));
                    }

                    canvas.lastPoint = {x: e.offsetX, y: e.offsetY};
                }
            });

            canvas.source.bind("mouseup", function(e) {
                canvas.isPainting = false;
            });
        }

        function drawLine(part, line) {
            var ctx = (part == 1) ? c1.context : c2.context;

            ctx.beginPath();
            ctx.moveTo(line.x1, line.y1);
            ctx.lineTo(line.x2, line.y2);

            ctx.closePath();
            ctx.stroke();
        };

    </script>
</head>
<body>
<header>
    <h1><a href="index.html"><img src="media/HTML5_Logo_32.png" alt="H5" /></a> HTML5 Camp. Демонстрации</h1>
    <h2>Коммуникации - <span id="status" class="fail">Socket closed</span></h2>
</header>

<section>
    <section class="canvascontainer">
        <span class="view">hide</span>
        <canvas id="mycanvas" width="320" height="320" ></canvas>
    </section>
    <section class="canvascontainer">
        <span class="view">hide</span>
        <canvas id="othercanvas" width="320" height="320" ></canvas>
    </section>
</section>

<section>
    <form id="myform">
        <input type="text" id="chat" placeholder="type and press enter to chat" />

    </form>
    <ul id="log"></ul>
</section>

<footer><a href="http://twitter.com/#!/search?q=%23html5camp">#html5camp</a> | 30 ноября 2011г. | Санкт-Петербург</footer>
</body>
</html>
